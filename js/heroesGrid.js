import { EventEmitter } from './core.js';
import { HEROES } from './heroes.js';
const colSymbol = 'abcdefghijklmnop';
const rowCount = 7;
let parentSelector = '#grid';
const gridCN = 'heroes-grid';
const _grid = `<div class="${gridCN}"></div>`;
const gridWrapCN = 'heroes-grid-wrap';
const _gridWrap = `<div class="${gridWrapCN}"></div>`;
const rowCN = 'heroes-grid__row';
const _row = `<div class="${rowCN}"></div>`;
const colCN = 'heroes-grid__col';
const colTargetHeroCN = 'heroes-grid__col_hover';
const colTargetSymbolCN = 'heroes-grid__col_target';
const _col = `<div class="${colCN}"></div>`;
const symbolCN = 'heroes-grid__symbol';
const _symbol = `<div class="${symbolCN}"></div>`;
const imgWrapCN = 'heroes-grid__hero';
const _imgWrap = `<div class="${imgWrapCN}"></div>`;
const imgCN = 'heroes-grid__hero-img';
const _img = `<img class="${imgCN}">`;
class HeroesGridModel extends EventEmitter {
    constructor() {
        super(...arguments);
        this.heroes = HEROES;
    }
    getHero(id) {
        return this.heroes.find(hero => hero.id == id);
    }
}
class HeroesGridView extends EventEmitter {
    constructor(model) {
        super();
        this.elem = {
            $wrap: $(parentSelector),
            $grid: $(_grid)
        };
        this._model = model;
        this.elem.$grid
            .on('mouseenter', `.${colCN}`, event => this.setTarget(event.currentTarget))
            .on('mouseleave', event => this.setTarget(null))
            .on('click', `.${colCN}[data-id]`, event => this.emit('click', {
            hero: this._model.getHero($(event.currentTarget).attr('data-id')),
            event
        }));
    }
    setTarget(elem) {
        const $target = this.elem.$grid.find(`.${colCN}`);
        const id = $(elem).attr('data-id');
        $target.removeClass(`${colTargetHeroCN} ${colTargetSymbolCN}`);
        if (id) {
            const [col, row] = id.split('');
            const $hero = $target.filter(`[data-id="${id}"]`);
            const $symbol = $target.filter(`[data-target="${col}"], [data-target="${row}"]`);
            $hero.addClass(colTargetHeroCN);
            $symbol.addClass(colTargetSymbolCN);
        }
    }
    createSymbol(text) {
        const $symbol = $(_symbol);
        $symbol.text(text);
        return $symbol;
    }
    createHeroImage(hero) {
        const $imgWrap = $(_imgWrap);
        const $img = $(_img);
        $img.attr({
            src: hero.thumb,
            alt: hero.name
        });
        $imgWrap.append($img);
        return $imgWrap;
    }
    initGrid() {
        const $wrap = this.elem.$wrap;
        const $grid = this.elem.$grid;
        const $gridWrap = $(_gridWrap);
        $gridWrap.append($grid).appendTo($wrap);
        for (let i = -1; i <= rowCount; i++) {
            const $row = $(_row);
            for (let j = -1; j <= colSymbol.length; j++) {
                const $col = $(_col);
                if (i == -1 || i == rowCount) {
                    $col.attr('data-target', colSymbol[j]);
                    $col.append(this.createSymbol(colSymbol[j]));
                }
                else {
                    if (j == -1 || j == colSymbol.length) {
                        $col.attr('data-target', i + 1);
                        $col.append(this.createSymbol(i + 1));
                    }
                    else {
                        const hero = this._model.getHero(colSymbol[j] + (i + 1));
                        const $img = this.createHeroImage(hero);
                        $col.attr('data-id', hero.id);
                        $col.append($img);
                    }
                }
                $row.append($col);
            }
            $grid.append($row);
        }
    }
    render() {
        this.initGrid();
    }
}
class HeroesGridController {
    constructor(model, view) {
        this.click = function (info) { };
        this._model = model;
        this._view = view;
        view.on('click', (info) => this.click(info));
    }
}
export class HeroesGrid {
    constructor(gridOpt) {
        if (gridOpt) {
            if (gridOpt.parent)
                parentSelector = gridOpt.parent;
        }
        this.model = new HeroesGridModel();
        this.view = new HeroesGridView(this.model);
        this.controller = new HeroesGridController(this.model, this.view);
        this.$gridElem = this.view.elem.$grid;
        this.view.render();
    }
    getHero(id) {
        return this.model.getHero(id);
    }
    on(event, callback) {
        this.controller[event] = callback;
        return this;
    }
}

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q3hDLElBQUksQ0FBQyxJQUFJLEdBQVMsSUFBSSxjQUFjLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVsRSxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUV0QyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxPQUFPLENBQUMsRUFBVTtRQUNkLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELEVBQUUsQ0FBQyxLQUFhLEVBQUUsUUFBa0I7UUFDaEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsR0FBRyxRQUFRLENBQUM7UUFDbEMsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKIiwiZmlsZSI6Imhlcm9lc0dyaWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICcuL2NvcmUuanMnO1xyXG5pbXBvcnQgeyBIRVJPRVMgfSBmcm9tICcuL2hlcm9lcy5qcyc7XHJcbmltcG9ydCB7IEhlcm8sIEdyaWRPcHRpb25zIH0gZnJvbSAnLi90eXBlcyc7XHJcblxyXG5jb25zdCBjb2xTeW1ib2wgPSAnYWJjZGVmZ2hpamtsbW5vcCc7XHJcbmNvbnN0IHJvd0NvdW50ID0gNztcclxuXHJcbmxldCBwYXJlbnRTZWxlY3RvciA9ICcjZ3JpZCc7XHJcblxyXG5jb25zdCBncmlkQ04gPSAnaGVyb2VzLWdyaWQnO1xyXG5jb25zdCBfZ3JpZCA9IGA8ZGl2IGNsYXNzPVwiJHtncmlkQ059XCI+PC9kaXY+YDtcclxuXHJcbmNvbnN0IGdyaWRXcmFwQ04gPSAnaGVyb2VzLWdyaWQtd3JhcCc7XHJcbmNvbnN0IF9ncmlkV3JhcCA9IGA8ZGl2IGNsYXNzPVwiJHtncmlkV3JhcENOfVwiPjwvZGl2PmA7XHJcblxyXG5jb25zdCByb3dDTiA9ICdoZXJvZXMtZ3JpZF9fcm93JztcclxuY29uc3QgX3JvdyA9IGA8ZGl2IGNsYXNzPVwiJHtyb3dDTn1cIj48L2Rpdj5gO1xyXG5cclxuY29uc3QgY29sQ04gPSAnaGVyb2VzLWdyaWRfX2NvbCc7XHJcbmNvbnN0IGNvbFRhcmdldEhlcm9DTiA9ICdoZXJvZXMtZ3JpZF9fY29sX2hvdmVyJztcclxuY29uc3QgY29sVGFyZ2V0U3ltYm9sQ04gPSAnaGVyb2VzLWdyaWRfX2NvbF90YXJnZXQnO1xyXG5jb25zdCBfY29sID0gYDxkaXYgY2xhc3M9XCIke2NvbENOfVwiPjwvZGl2PmA7XHJcblxyXG5jb25zdCBzeW1ib2xDTiA9ICdoZXJvZXMtZ3JpZF9fc3ltYm9sJztcclxuY29uc3QgX3N5bWJvbCA9IGA8ZGl2IGNsYXNzPVwiJHtzeW1ib2xDTn1cIj48L2Rpdj5gO1xyXG5cclxuY29uc3QgaW1nV3JhcENOID0gJ2hlcm9lcy1ncmlkX19oZXJvJztcclxuY29uc3QgX2ltZ1dyYXAgPSBgPGRpdiBjbGFzcz1cIiR7aW1nV3JhcENOfVwiPjwvZGl2PmA7XHJcblxyXG5jb25zdCBpbWdDTiA9ICdoZXJvZXMtZ3JpZF9faGVyby1pbWcnO1xyXG5jb25zdCBfaW1nID0gYDxpbWcgY2xhc3M9XCIke2ltZ0NOfVwiPmA7XHJcblxyXG5cclxuY2xhc3MgSGVyb2VzR3JpZE1vZGVsIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcclxuICAgIGhlcm9lczogSGVyb1tdID0gSEVST0VTO1xyXG5cclxuICAgIGdldEhlcm8oaWQ6IHN0cmluZyk6IEhlcm8ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmhlcm9lcy5maW5kKGhlcm8gPT4gaGVyby5pZCA9PSBpZCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmNsYXNzIEhlcm9lc0dyaWRWaWV3IGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcclxuICAgIF9tb2RlbDogSGVyb2VzR3JpZE1vZGVsO1xyXG5cclxuICAgIGVsZW0gPSB7XHJcbiAgICAgICAgJHdyYXA6ICQocGFyZW50U2VsZWN0b3IpLFxyXG4gICAgICAgICRncmlkOiAkKF9ncmlkKVxyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcihtb2RlbDogSGVyb2VzR3JpZE1vZGVsKSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuXHJcbiAgICAgICAgdGhpcy5fbW9kZWwgPSBtb2RlbDtcclxuXHJcbiAgICAgICAgdGhpcy5lbGVtLiRncmlkXHJcbiAgICAgICAgICAgIC5vbignbW91c2VlbnRlcicsIGAuJHtjb2xDTn1gLCBldmVudCA9PiB0aGlzLnNldFRhcmdldChldmVudC5jdXJyZW50VGFyZ2V0KSlcclxuICAgICAgICAgICAgLm9uKCdtb3VzZWxlYXZlJywgZXZlbnQgPT4gdGhpcy5zZXRUYXJnZXQobnVsbCkpXHJcbiAgICAgICAgICAgIC5vbignY2xpY2snLCBgLiR7Y29sQ059W2RhdGEtaWRdYCwgZXZlbnQgPT4gdGhpcy5lbWl0KCdjbGljaycsIHtcclxuICAgICAgICAgICAgICAgIGhlcm86IHRoaXMuX21vZGVsLmdldEhlcm8oICQoZXZlbnQuY3VycmVudFRhcmdldCkuYXR0cignZGF0YS1pZCcpICksXHJcbiAgICAgICAgICAgICAgICBldmVudFxyXG4gICAgICAgICAgICB9KSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0VGFyZ2V0KGVsZW06IEhUTUxFbGVtZW50KSB7XHJcbiAgICAgICAgY29uc3QgJHRhcmdldCA9IHRoaXMuZWxlbS4kZ3JpZC5maW5kKGAuJHtjb2xDTn1gKTtcclxuICAgICAgICBjb25zdCBpZCA9ICQoZWxlbSkuYXR0cignZGF0YS1pZCcpO1xyXG5cclxuICAgICAgICAkdGFyZ2V0LnJlbW92ZUNsYXNzKGAke2NvbFRhcmdldEhlcm9DTn0gJHtjb2xUYXJnZXRTeW1ib2xDTn1gKTtcclxuXHJcbiAgICAgICAgaWYgKGlkKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IFtjb2wsIHJvd10gPSBpZC5zcGxpdCgnJyk7XHJcbiAgICAgICAgICAgIGNvbnN0ICRoZXJvID0gJHRhcmdldC5maWx0ZXIoYFtkYXRhLWlkPVwiJHtpZH1cIl1gKTtcclxuICAgICAgICAgICAgY29uc3QgJHN5bWJvbCA9ICR0YXJnZXQuZmlsdGVyKGBbZGF0YS10YXJnZXQ9XCIke2NvbH1cIl0sIFtkYXRhLXRhcmdldD1cIiR7cm93fVwiXWApO1xyXG5cclxuICAgICAgICAgICAgJGhlcm8uYWRkQ2xhc3MoY29sVGFyZ2V0SGVyb0NOKTtcclxuICAgICAgICAgICAgJHN5bWJvbC5hZGRDbGFzcyhjb2xUYXJnZXRTeW1ib2xDTik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNyZWF0ZVN5bWJvbCh0ZXh0OiBzdHJpbmcgfCBudW1iZXIpOiBKUXVlcnkge1xyXG4gICAgICAgIGNvbnN0ICRzeW1ib2wgPSAkKF9zeW1ib2wpO1xyXG4gICAgICAgICRzeW1ib2wudGV4dCh0ZXh0KTtcclxuXHJcbiAgICAgICAgcmV0dXJuICRzeW1ib2w7XHJcbiAgICB9XHJcblxyXG4gICAgY3JlYXRlSGVyb0ltYWdlKGhlcm86IEhlcm8pOiBKUXVlcnkge1xyXG4gICAgICAgIGNvbnN0ICRpbWdXcmFwID0gJChfaW1nV3JhcCk7XHJcbiAgICAgICAgY29uc3QgJGltZyA9ICQoX2ltZyk7XHJcblxyXG4gICAgICAgICRpbWcuYXR0cih7XHJcbiAgICAgICAgICAgIHNyYzogaGVyby50aHVtYixcclxuICAgICAgICAgICAgYWx0OiBoZXJvLm5hbWVcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgJGltZ1dyYXAuYXBwZW5kKCRpbWcpO1xyXG5cclxuICAgICAgICByZXR1cm4gJGltZ1dyYXA7XHJcbiAgICB9XHJcblxyXG4gICAgaW5pdEdyaWQoKSB7XHJcbiAgICAgICAgY29uc3QgJHdyYXAgPSB0aGlzLmVsZW0uJHdyYXA7XHJcbiAgICAgICAgY29uc3QgJGdyaWQgPSB0aGlzLmVsZW0uJGdyaWQ7XHJcbiAgICAgICAgY29uc3QgJGdyaWRXcmFwID0gJChfZ3JpZFdyYXApO1xyXG5cclxuICAgICAgICAkZ3JpZFdyYXAuYXBwZW5kKCRncmlkKS5hcHBlbmRUbygkd3JhcCk7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAtMTsgaSA8PSByb3dDb3VudDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGNvbnN0ICRyb3cgPSAkKF9yb3cpO1xyXG5cclxuICAgICAgICAgICAgZm9yIChsZXQgaiA9IC0xOyBqIDw9IGNvbFN5bWJvbC5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgJGNvbCA9ICQoX2NvbCk7XHJcbiAgICAgICAgXHJcbiAgICAgICAgICAgICAgICBpZiAoaSA9PSAtMSB8fCBpID09IHJvd0NvdW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgJGNvbC5hdHRyKCdkYXRhLXRhcmdldCcsIGNvbFN5bWJvbFtqXSk7XHJcbiAgICAgICAgICAgICAgICAgICAgJGNvbC5hcHBlbmQoIHRoaXMuY3JlYXRlU3ltYm9sKCBjb2xTeW1ib2xbal0gKSApO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoaiA9PSAtMSB8fCBqID09IGNvbFN5bWJvbC5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGNvbC5hdHRyKCdkYXRhLXRhcmdldCcsIGkgKyAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgJGNvbC5hcHBlbmQoIHRoaXMuY3JlYXRlU3ltYm9sKCBpICsgMSApICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaGVybyA9IHRoaXMuX21vZGVsLmdldEhlcm8oY29sU3ltYm9sW2pdICsgKGkgKyAxKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0ICRpbWcgPSB0aGlzLmNyZWF0ZUhlcm9JbWFnZShoZXJvKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICRjb2wuYXR0cignZGF0YS1pZCcsIGhlcm8uaWQpO1xyXG4gICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAkY29sLmFwcGVuZCgkaW1nKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgJHJvdy5hcHBlbmQoJGNvbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgJGdyaWQuYXBwZW5kKCRyb3cpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICByZW5kZXIoKSB7XHJcbiAgICAgICAgdGhpcy5pbml0R3JpZCgpO1xyXG4gICAgfVxyXG59XHJcblxyXG5jbGFzcyBIZXJvZXNHcmlkQ29udHJvbGxlciB7XHJcbiAgICBfbW9kZWw6IEhlcm9lc0dyaWRNb2RlbDtcclxuICAgIF92aWV3OiBIZXJvZXNHcmlkVmlldztcclxuXHJcbiAgICBjbGljayA9IGZ1bmN0aW9uKGluZm8pIHt9O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG1vZGVsOiBIZXJvZXNHcmlkTW9kZWwsIHZpZXc6IEhlcm9lc0dyaWRWaWV3KSB7XHJcbiAgICAgICAgdGhpcy5fbW9kZWwgPSBtb2RlbDtcclxuICAgICAgICB0aGlzLl92aWV3ID0gdmlldztcclxuXHJcbiAgICAgICAgdmlldy5vbignY2xpY2snLCAoaW5mbykgPT4gdGhpcy5jbGljayhpbmZvKSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBIZXJvZXNHcmlkIHsgXHJcbiAgICBtb2RlbDogSGVyb2VzR3JpZE1vZGVsO1xyXG4gICAgdmlldyA6IEhlcm9lc0dyaWRWaWV3O1xyXG4gICAgY29udHJvbGxlcjogSGVyb2VzR3JpZENvbnRyb2xsZXI7XHJcblxyXG4gICAgJGdyaWRFbGVtOiBKUXVlcnk7XHJcblxyXG4gICAgY29uc3RydWN0b3IoZ3JpZE9wdD86IEdyaWRPcHRpb25zKSB7XHJcbiAgICAgICAgaWYgKGdyaWRPcHQpIHtcclxuICAgICAgICAgICAgaWYgKGdyaWRPcHQucGFyZW50KSBwYXJlbnRTZWxlY3RvciA9IGdyaWRPcHQucGFyZW50O1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5tb2RlbCAgICAgID0gbmV3IEhlcm9lc0dyaWRNb2RlbCgpO1xyXG4gICAgICAgIHRoaXMudmlldyAgICAgICA9IG5ldyBIZXJvZXNHcmlkVmlldyh0aGlzLm1vZGVsKTtcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIgPSBuZXcgSGVyb2VzR3JpZENvbnRyb2xsZXIodGhpcy5tb2RlbCwgdGhpcy52aWV3KTtcclxuXHJcbiAgICAgICAgdGhpcy4kZ3JpZEVsZW0gPSB0aGlzLnZpZXcuZWxlbS4kZ3JpZDtcclxuXHJcbiAgICAgICAgdGhpcy52aWV3LnJlbmRlcigpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEhlcm8oaWQ6IHN0cmluZyk6IEhlcm8ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm1vZGVsLmdldEhlcm8oaWQpO1xyXG4gICAgfVxyXG5cclxuICAgIG9uKGV2ZW50OiBzdHJpbmcsIGNhbGxiYWNrOiBGdW5jdGlvbikge1xyXG4gICAgICAgIHRoaXMuY29udHJvbGxlcltldmVudF0gPSBjYWxsYmFjaztcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxufSJdfQ==
